PREFIX : <https://joinup.ec.europa.eu/collection/rpam/1.1.0/ontology#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX ccts: <http://www.unece.org/cefact#>
PREFIX cc: <https://joinup.ec.europa.eu/collection/rpam/1.0.0/thesauri/countrycode#>
PREFIX ccev: <https://joinup.ec.europa.eu/collection/semic/ccev/2.0.3/ontology#>
PREFIX foaf: <http://xmlns.com/foaf/0.1/>
PREFIX ubl: <http://docs.oasis-open.org/ubl#>
PREFIX mee: <https://joinup.ec.europa.eu/collection/rpam/1.1.0/mandates#>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX ct: <https://joinup.ec.europa.eu/collection/rpam/1.0.0/thesauri/moremee#>

# USER STORY: All the mandates where Paula has been empowered with one power, the constraints of the mandator and the constraints of Paula on the use of that power.

    select distinct ?Mandate ?Power ?Mandator ?MorConstraintType ?Mor_Constraint ?MeeConstraintType ?Paula_Constraint
    from mee:
	from ct:
    where {
        ?Mandate a  :Mandate ;
                 :mandator ?Mandator ;
                 :empowerment ?Power .
        ?Power :mandatee :Paula ;
               :mandatorConstraint ?MorConstraint ;
               :mandateeConstraint ?MeeConstraint .
    	?MorConstraint ccev:constraint ?MorConstraintNode ; ccev:type ?MorConstraintType .
		?MorConstraintType skos:definition ?MorDef .
		?MeeConstraint ccev:constraint ?MeeConstraintNode ; ccev:type ?MeeConstraintType .
    	?MeeConstraintType skos:definition ?MeeDef

        optional {?MorConstraintNode ccev:datumCode [ccts:codeValue ?MorTu]}
        optional {?MorConstraintNode ccev:datumIndicator ?MorOsu}
        optional {?MorConstraintNode ccev:datumPeriod [ubl:endDate ?MorEndDate]}
        optional {?MorConstraintNode ccev:datumAmount [ccts:amountValue ?MorCeil ; ccts:currencyID ?MorCeilCur]}
        optional {?MorConstraintNode ccev:datumAmount [ccts:amountValue ?Morfloor ; ccts:currencyID ?MorFloorCur]}

		optional {?MeeConstraintNode ccev:datumCode [ccts:codeValue ?MeeTu]}
        optional {?MeeConstraintNode ccev:datumIndicator ?MeeOsu}
        optional {?MeeConstraintNode ccev:datumPeriod [ubl:endDate ?MeeEndDate]}
        optional {?MeeConstraintNode ccev:datumAmount [ccts:amountValue ?MeeCeil ; ccts:currencyID ?MeeCeilCur]}
        optional {?MeeConstraintNode ccev:datumAmount [ccts:amountValue ?Meefloor ; ccts:currencyID ?MeeFloorCur]}

        bind(if (str(?MorTu) != "", concat(str(?MorDef),  ": ",  str(?MorTu)), "") as ?Mor_Constraint)
        bind(if (?MorOsu, str(?MorDef), "This power can be used repeatedly (more than once) while the power is valid.") as ?Mor_Constraint)
        bind(if (str(?MorCeil) !="", concat(str(?MorDef), " ", str(?MorCeil), " ", ?MorCeilCur), "") as ?Mor_Constraint)
        bind(if (str(?MorEndDate) !="", concat(str(?MorDef),  ": ", str(?MorEndDate)), "") as ?Mor_Constraint)

        bind(if (str(?MeeTu) != "", concat(str(?MeeDef),  ": ",  str(?MeeTu)), "") as ?Paula_Constraint)
        bind(if (?MeeOsu, str(?MeeDef), "This power can be used repeatedly (more than once) while the power is valid.") as ?Paula_Constraint)
        bind(if (str(?MeeCeil) !="", concat(str(?MeeDef), " ", str(?MeeCeil), " ", ?MeeCeilCur), "") as ?Paula_Constraint)
        bind(if (str(?MeeEndDate) !="", concat(str(?MeeDef),  ": ", str(?MeeEndDate)), "") as ?Paula_Constraint)
    }
